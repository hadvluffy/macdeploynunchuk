name: nunchuk-window-x86_64

on:
  push:
    tags:
    - '*'
  workflow_dispatch:
  
jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        
      - name: Check Windows Version
        shell: pwsh
        run: systeminfo | findstr /B /C:"OS Name" /C:"OS Version"

      - name: Setup msbuild
        uses: microsoft/setup-msbuild@v2
        with:
            msbuild-architecture: x64

      - name: Setup CMake
        uses: lukka/get-cmake@latest

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install aqtinstall
        run: |
          pip install aqtinstall
  
      - name: Install Qt 5.15.2 (MSVC 2019)
        run: |
          aqt list-qt windows desktop --modules 5.15.2 win64_msvc2019_64
          aqt install-qt windows desktop 5.15.2 win64_msvc2019_64 --outputdir C:\qt --archives
          aqt install-qt windows desktop 5.15.2 win64_msvc2019_64 `
                      --outputdir C:\qt `
                      -m `
                      qtcharts `
                      qtdatavis3d `
                      qtlottie `
                      qtnetworkauth `
                      qtpurchasing `
                      qtquick3d `
                      qtquicktimeline `
                      qtscript `
                      qtvirtualkeyboard `
                      qtwebengine `
                      qtwebglplugin `
                      debug_info
          Write-Host "Qt installed at: $qtPath\windows\desktop\$qtVersion\msvc2019_64"
      
      - name: Print Qt installation path
        run: |
          echo "Qt installed at: C:\qt\5.15.2\msvc2019_64"
          dir C:\qt\5.15.2\msvc2019_64
          dir C:\qt\5.15.2\msvc2019_64\bin
      
      - name: Set Qt env
        run: |
          echo "QT_DIR=C:\qt\5.15.2\msvc2019_64" >> $GITHUB_ENV

      - name: Setup Cache vcpkg packages
        uses: actions/cache@v4
        with:
          path: |
            ${{ runner.workspace }}/vcpkg
            ${{ runner.workspace }}/vcpkg/installed
          key: vcpkg-full-${{ runner.os }}-${{ github.ref }}-${{ hashFiles('**/vcpkg.json') }}
          restore-keys: |
            vcpkg-full-${{ runner.os }}-

      - name: Set up vcpkg
        working-directory: ${{ runner.workspace }}
        shell: pwsh
        run: |
          git clone https://github.com/microsoft/vcpkg.git
          cd vcpkg
          echo "Checkout version eb492805e92a2c14a230f5c3deb3e89f6771c321"
          git checkout eb492805e92a2c14a230f5c3deb3e89f6771c321
          .\bootstrap-vcpkg.bat
          
      - name: Install dependencies with vcpkg
        working-directory: ${{ runner.workspace }}
        shell: pwsh
        run: |
          vcpkg\vcpkg.exe install boost:x64-windows `
                                  zeromq:x64-windows `
                                  libevent:x64-windows `
                                  berkeleydb:x64-windows `
                                  sqlite3:x64-windows `
                                  sqlcipher:x64-windows
                        
          vcpkg\vcpkg.exe integrate install
          vcpkg\vcpkg.exe list

      - name: Checkout Olm
        working-directory: ${{ runner.workspace }}
        run: git clone https://gitlab.matrix.org/matrix-org/olm.git
      
      - name: Build Olm
        working-directory: ${{ runner.workspace }}/olm
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build --config Release
