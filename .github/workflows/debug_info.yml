name: debug_info

on:
  push:
    tags:
    - '*'

  workflow_dispatch:

jobs:
  build:
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Qt 5.15.2 (using aqtinstall in a venv, prefer arm64)
        shell: bash
        run: |
          set -euo pipefail

          QT_VERSION="5.15.2"
          OUTDIR="${{ github.workspace }}/Qt/${QT_VERSION}"
          VENV_DIR="${{ runner.temp }}/pyvenv_aqt"
          mkdir -p "$OUTDIR"
          rm -rf "$VENV_DIR"
          python3 -m venv "$VENV_DIR"
          # activate venv for the rest of the step
          source "$VENV_DIR/bin/activate"

          python -V
          pip install --upgrade pip setuptools wheel
          pip install aqtinstall

          echo "Available Qt archives for mac desktop ${QT_VERSION}:"
          aqt list-qt mac desktop "$QT_VERSION" || true

          # prefer clang_arm64, then macos_universal, then clang_64
          WANT_ARCH=""
          if aqt list-qt mac desktop "$QT_VERSION" | grep -q "clang_arm64"; then
            WANT_ARCH="clang_arm64"
          elif aqt list-qt mac desktop "$QT_VERSION" | grep -q "macos_universal"; then
            WANT_ARCH="macos_universal"
          elif aqt list-qt mac desktop "$QT_VERSION" | grep -q "clang_64"; then
            WANT_ARCH="clang_64"
          else
            echo "No expected archive names found for Qt $QT_VERSION; aborting."
            exit 1
          fi

          echo "Selected Qt archive: $WANT_ARCH"

          aqt install-qt mac desktop "$QT_VERSION" "$WANT_ARCH" --outputdir "$OUTDIR" --assume-yes

          # Find qmake path and set QTPATH
          QMAKE_PATH=$(find "$OUTDIR" -type f -name qmake -print -quit || true)
          if [ -z "$QMAKE_PATH" ]; then
            echo "Failed to find qmake under $OUTDIR â€” listing contents for debug:"
            ls -R "$OUTDIR" || true
            exit 1
          fi

          QTPATH="$(dirname "$(dirname "$QMAKE_PATH")")"
          echo "Installed QTPATH: $QTPATH"

          echo "## ls lib ##"
          ls -la "$QTPATH/lib" || true
          echo "## file libQt5Core.dylib ##"
          if [ -f "$QTPATH/lib/libQt5Core.dylib" ]; then
            file "$QTPATH/lib/libQt5Core.dylib" || true
            lipo -info "$QTPATH/lib/libQt5Core.dylib" || true
            otool -L "$QTPATH/lib/libQt5Core.dylib" || true
          else
            echo "libQt5Core.dylib not found at $QTPATH/lib"
          fi

          echo "## qmake info ##"
          "$QMAKE_PATH" -v || true
          "$QMAKE_PATH" -query || true

          # Export env vars for following steps
          echo "QTPATH=$QTPATH" >> $GITHUB_ENV
          echo "CMAKE_PREFIX_PATH=$QTPATH/lib/cmake" >> $GITHUB_ENV
          echo "PATH=$QTPATH/bin:$PATH" >> $GITHUB_ENV

          # Unset CC/CXX to prefer Apple clang
          unset CC || true
          unset CXX || true
          echo "Unset CC/CXX to prefer Apple clang for building Qt apps"


